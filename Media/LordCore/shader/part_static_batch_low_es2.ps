#version 100

uniform mediump sampler2D uMaterialLayerTexture;    // 图集
uniform mediump vec2 uMaterialLayerScale;
uniform mediump vec2 uInvTextureSize;

varying mediump vec4  ourTexcoord;
varying mediump vec4  ourColor;
varying mediump vec3  ourLightFactor;
varying mediump vec4  ourFogColor;

mediump vec3 SamplerMaterialLayerTexture(mediump vec4 texcoord) {
    mediump vec2 uv = fract(texcoord.xy) * uMaterialLayerScale;     
    uv = clamp(uv - 2.0 * uInvTextureSize, vec2(0.0, 0.0), uMaterialLayerScale);
    uv += texcoord.zw;
    uv += uInvTextureSize;
    return texture2D(uMaterialLayerTexture, uv).xyz;   
}

void main() {
    mediump vec3 albedo = SamplerMaterialLayerTexture(ourTexcoord) * vec3(ourColor);
    mediump vec3 result = albedo * ourLightFactor;
	gl_FragColor = vec4(mix(ourFogColor.rgb, result, ourFogColor.a), ourColor.a);
}